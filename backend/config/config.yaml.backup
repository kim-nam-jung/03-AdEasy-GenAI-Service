cd ~/ADEASY_SHORTS

cat > config/config.yaml << 'EOF'
# config/config.yaml - ADEASY_SHORTS v2.3
# Overall Workflow v2.3 완벽 반영

# ============================================
# 1. 프로젝트 메타
# ============================================
app:
  name: "ADEASY_SHORTS"
  version: "v2.3"
  timezone: "Asia/Seoul"

# ============================================
# 2. 경로 설정
# ============================================
paths:
  repo_root: null  # null이면 TaskPaths가 자동 탐지
  data_dir: "data"
  inputs_dir: "data/inputs"
  temp_dir: "data/temp"
  outputs_dir: "outputs"
  models_dir: "models"
  bgm_dir: "data/bgm"
  fonts_dir: "assets/fonts"

# ============================================
# 3. 모델 설정 (HuggingFace + 로컬)
# ============================================
models:
  # HuggingFace 캐시 디렉토리
  cache_dir: "/home/spai0432/cache/hf"
  
  # Step 0: FastSAM (배경 제거)
  fastsam:
    # repo_id는 모델 확정 후 추가 예정
    local_dir: "models/fastsam"
    device: "cuda"
  
  # Step 1: Qwen-VL (이미지 이해)
  qwen_vl:
    repo_id: "Qwen/Qwen2-VL-7B-Instruct"
    local_dir: "models/qwen_vl"
    device: "cuda"
    quantization: "8bit"
    max_tokens: 512
  
  # Step 2: Qwen-LLM (광고 기획)
  qwen_llm:
    repo_id: "Qwen/Qwen2.5-7B-Instruct"
    local_dir: "models/qwen_llm"
    device: "cuda"
    quantization: "8bit"
    temperature: 0.7
    max_tokens: 1024
  
  # Step 3: ControlNet (구도 제약)
  controlnet:
    repo_id: "diffusers/controlnet-canny-sdxl-1.0"
    local_dir: "models/controlnet"
    device: "cuda"
    conditioning_scale: 0.8
  
  # Step 4: SDXL (키프레임 생성)
  sdxl:
    repo_id: "stabilityai/stable-diffusion-xl-base-1.0"
    local_dir: "models/sdxl"
    device: "cuda"
    steps: 30
    guidance_scale: 7.5
    negative_prompt: "blurry, low quality, distorted, ugly, watermark, text, logo"
  
  # Step 5: Wan v2.6 (I2V) - 24fps 출력 전제!
  wan:
    # repo_id는 모델 확정 후 추가 예정
    local_dir: "models/wan"
    device: "cuda"
    output_fps: 24  # ⚠️ 워크플로우 v2.3 전제: 24fps
    num_inference_steps: 50
  
  # Step 6: RIFE (프레임 보간) - 조건부 적용
  rife:
    model: "rife-v4.6"
    local_dir: "models/rife"
    device: "cuda"
  
  # Step 7: ESRGAN (업스케일)
  esrgan:
    # repo_id는 모델 확정 후 추가 예정
    local_dir: "models/esrgan"
    device: "cuda"
    scale: 2

# ============================================
# 4. 비디오 설정 (워크플로우 v2.3 확정)
# ============================================
video:
  # 최종 출력 해상도
  resolution:
    width: 1080
    height: 1920
  fps: 24  # 전체 타겟 FPS
  duration: 15  # 초
  
  # 씬 구성 (워크플로우 v2.3 확정)
  scenes:
    count: 3
    durations_sec: [5.5, 5.0, 5.0]  # Scene1=132f, Scene2/3=120f
    frame_counts: [132, 120, 120]    # 24fps 기준
  
  # 전환 효과 (Dissolve)
  transitions:
    type: "dissolve"
    duration_sec: 0.5
    overlap_frames: 12  # 24fps 기준 (0.5s * 24)
  
  # 인코딩 설정
  encode:
    vcodec: "libx264"
    acodec: "aac"
    crf: 18
    preset: "medium"
    pix_fmt: "yuv420p"
    audio_bitrate: "192k"

# ============================================
# 5. 키프레임 생성 설정 (워크플로우 v2.3 확정)
# ============================================
keyframe:
  # ⚠️ Wan 최적화 크기 (704x1280) - 변경 금지!
  size: [704, 1280]
  controlnet_scale: 0.8
  negative_prompt_default: "blurry, low quality, distorted, ugly, watermark, text"

# ============================================
# 6. 포스트프로세싱
# ============================================
postprocess:
  # RIFE 프레임 보간 (조건부)
  rife:
    enabled: true
    target_fps: 24
    apply_if_fps_below: 24  # Wan이 24fps 미만일 때만 적용
  
  # ESRGAN 업스케일
  esrgan:
    enabled: true
    scale: 2
  
  # FFmpeg 스케일/크롭 (최종 1080x1920)
  ffmpeg_scale_crop:
    enabled: true
    scale:
      width: 1080
      height: 1920
      force_original_aspect_ratio: "increase"
    crop:
      width: 1080
      height: 1920

# ============================================
# 7. VRAM 관리 정책 (L4 24GB 기준)
# ============================================
vram:
  # Gate #1: Qwen → ControlNet/SDXL
  gate1:
    free_gb_required: 8  # 8GB 이상 확보 필요
    cleanup_target_gb: 2  # 정리 후 2GB 이하 목표
  
  # Gate #2: SDXL → Wan
  gate2:
    free_gb_required: 8  # 8GB 이상 확보 필요
    cleanup_target_gb: 2
  
  safety_margin_gb: 2  # 안전 마진

# ============================================
# 8. 품질 검증 (워크플로우 v2.3 확정)
# ============================================
quality:
  # 아이덴티티 보존 임계값
  identity_score_threshold: 0.90
  
  # SSIM 기반 프레임 샘플링 (24fps 기준)
  ssim:
    sample_every_n_frames: 24  # 1초당 1프레임
    top_percent: 50

# ============================================
# 9. Redis 설정
# ============================================
redis:
  url_env: "REDIS_URL"  # .env에서 읽기
  default_url: "redis://localhost:6379/0"
  key_prefix: "task:"
  ttl_seconds: 86400  # 24시간

# ============================================
# 10. Celery 설정 (비동기 작업)
# ============================================
celery:
  broker_url: "redis://localhost:6379/0"
  result_backend: "redis://localhost:6379/0"
  task_serializer: "json"
  result_serializer: "json"
  accept_content: ["json"]
  timezone: "Asia/Seoul"
  enable_utc: true

# ============================================
# 11. 로깅 설정
# ============================================
logging:
  level: "INFO"
  to_console: true
  to_file: true
  format: "[%(asctime)s] %(levelname)s %(message)s"
  datefmt: "%Y-%m-%d %H:%M:%S"

# ============================================
# 12. FFmpeg 바이너리
# ============================================
ffmpeg:
  binary: "ffmpeg"
  ffprobe: "ffprobe"

# ============================================
# 13. 에셋 (폰트 등)
# ============================================
assets:
  font:
    noto_sans_kr_regular: "assets/fonts/NotoSansKR-Regular.ttf"
EOF

echo "✅ config.yaml (v2.3 워크플로우 완벽 반영) 생성 완료!"
