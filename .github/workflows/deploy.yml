name: Deploy to GCP VM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          port: 22
          script: |
            echo "ðŸš€ Starting Deployment..."
            
            # 1. Dynamically find the project directory (Smart Search)
            echo "ðŸ” Searching for project directory..."
            PROJECT_ROOT=$(find $HOME -type d -name "03-AdEasy-GenAI-Service" -not -path "*/.*" | head -n 1)
            
            if [ -z "$PROJECT_ROOT" ]; then
                # Try fallback name often used in guides
                PROJECT_ROOT=$(find $HOME -type d -name "adeasy" -not -path "*/.*" | head -n 1)
            fi
            
            if [ -z "$PROJECT_ROOT" ]; then
                echo "âŒ Error: Could not find project directory on VM."
                echo "Please ensure the project is cloned and has the correct name."
                exit 1
            fi
            
            echo "ðŸ“ Found project at: $PROJECT_ROOT"
            cd "$PROJECT_ROOT"
            
            # 2. Pull latest code (Hard reset to avoid merge conflicts)
            echo "ðŸ“¥ Fetching and resetting to latest code..."
            git fetch origin main
            git checkout main
            git reset --hard origin/main
            
            # 3. Pull LFS objects if any
            git lfs pull || echo "âš ï¸ Git LFS pull failed or not installed, skipping..."
            
            # 4. Rebuild and Restart Containers
            echo "ðŸ”„ Rebuilding containers..."
            # Try Docker Compose V2 first, then V1
            if docker compose version > /dev/null 2>&1; then
                DOCKER_CMD="docker compose"
            else
                DOCKER_CMD="docker-compose"
            fi
            
            echo "Using command: $DOCKER_CMD"
            $DOCKER_CMD down --remove-orphans
            
            # Ensure ports 3000 and 8000 are free (sometimes containers don't release them fast enough or orphaned processes exist)
            echo "ðŸ§¹ Clearing ports 3000 and 8000..."
            sudo fuser -k 3000/tcp || echo "Port 3000 already free"
            sudo fuser -k 8000/tcp || echo "Port 8000 already free"
            
            $DOCKER_CMD up -d --build --force-recreate
            
            # 5. Prune unused images
            docker image prune -f
            
            echo "âœ… Deployment Complete!"
